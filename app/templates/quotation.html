{% extends 'layout.html' %}

{% block title %}Quotations | ControlFlow{% endblock %}

{% block content %}
<h2 class="mb-4">Quotations</h2>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- Add Quotation Form -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-primary text-white">Add New Quotation</div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('quotation_routes.quotation') }}">
      <div class="row mb-3">
        <div class="col-md-4">
          <label class="form-label">Quotation Number</label>
          <input type="text" class="form-control" name="quotation_number" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Quotation Date</label>
          <input type="date" class="form-control" name="quotation_date" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Client Name</label>
          <input type="text" class="form-control" name="client_name" required>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Project Name</label>
        <input type="text" class="form-control" name="project_name" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Project Description & Scope</label>
        <textarea class="form-control" rows="3" name="project_description" required></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Estimated Cost (INR)</label>
        <input type="number" step="0.01" class="form-control" name="estimated_cost" required>
      </div>

      <button type="submit" class="btn btn-success">Save Quotation</button>
    </form>
  </div>
</div>

<!-- Quotations Table -->
<div class="card shadow-sm">
  <div class="card-header bg-light">Existing Quotations</div>
  <div class="card-body table-responsive">
    <table class="table table-bordered table-hover">
      <thead class="table-secondary">
        <tr>
          <th>#</th>
          <th>Quotation No</th>
          <th>Project Name</th>
          <th>Estimated Cost</th>
          <th>Status</th>
          <th>Quotation Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for quo in quotations %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ quo.quotation_number }}</td>
          <td>{{ quo.project_name }}</td>
          <td>â‚¹{{ quo.estimated_cost }}</td>
          <td>
            <span class="badge bg-{{ 'warning text-dark' if quo.status == 'Pending' else ('success' if quo.status == 'Accepted' else 'danger') }}">
              {{ quo.status }}
            </span>
          </td>
          <td>{{ quo.quotation_date.strftime('%Y-%m-%d') }}</td>
          <td>
            <!-- Edit Button -->
            <button
              class="btn btn-sm btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#editModal{{ quo.id }}"
            >
              Edit
            </button>

            <!-- Delete Button -->
            <button
              class="btn btn-sm btn-danger"
              data-bs-toggle="modal"
              data-bs-target="#deleteModal{{ quo.id }}"
            >
              Delete
            </button>

            <!-- Edit Modal -->
            <div class="modal fade" id="editModal{{ quo.id }}" tabindex="-1" aria-labelledby="editModalLabel{{ quo.id }}" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <form method="POST" action="{{ url_for('quotation_routes.edit_quotation', id=quo.id) }}">
                    <div class="modal-header">
                      <h5 class="modal-title">Edit Quotation</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      <div class="row mb-3">
                        <div class="col-md-4">
                          <label class="form-label">Quotation Number</label>
                          <input type="text" class="form-control" name="quotation_number" value="{{ quo.quotation_number }}" required>
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">Quotation Date</label>
                          <input type="date" class="form-control" name="quotation_date" value="{{ quo.quotation_date.strftime('%Y-%m-%d') }}" required>
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">Client Name</label>
                          <input type="text" class="form-control" name="client_name" value="{{ quo.client_name }}" required>
                        </div>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Project Name</label>
                        <input type="text" class="form-control" name="project_name" value="{{ quo.project_name }}" required>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Project Description & Scope</label>
                        <textarea class="form-control" rows="3" name="project_description" required>{{ quo.project_description }}</textarea>
                      </div>

                      <div class="mb-3">
                        <label class="form-label">Estimated Cost (INR)</label>
                        <input type="number" step="0.01" class="form-control" name="estimated_cost" value="{{ quo.estimated_cost }}" required>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-success">Update</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Delete Modal -->
            <div class="modal fade" id="deleteModal{{ quo.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ quo.id }}" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <form method="POST" action="{{ url_for('quotation_routes.delete_quotation', id=quo.id) }}">
                    <div class="modal-header">
                      <h5 class="modal-title">Confirm Delete</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                      Are you sure you want to delete quotation <strong>{{ quo.quotation_number }}</strong>?
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="submit" class="btn btn-danger">Delete</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
